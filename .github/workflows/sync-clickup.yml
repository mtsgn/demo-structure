name: Sync BMAD Artifacts to ClickUp

on:
  push:
    branches: [main]
    paths:
      - '_bmad-output/epics/**/*.md'
      - '_bmad-output/stories/**/*.md'

env:
  CLICKUP_EPICS_LIST_ID: "901815396322"
  CLICKUP_STORIES_LIST_ID: "901815396340"

permissions:
  contents: write

jobs:
  sync-to-clickup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Changed Files
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '_bmad-output/(epics|stories)/.*\.md$' | tr '\n' ' ' || echo "")
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
          echo "Found: $CHANGED"

      - name: Sync to ClickUp
        if: steps.changed.outputs.files != ''
        env:
          CLICKUP_API_KEY: ${{ secrets.CLICKUP_API_KEY }}
          EPICS_LIST: ${{ env.CLICKUP_EPICS_LIST_ID }}
          STORIES_LIST: ${{ env.CLICKUP_STORIES_LIST_ID }}
        run: |
          echo "Starting sync..."
          
          for file in ${{ steps.changed.outputs.files }}; do
            echo "== Processing: $file =="
            
            # Read frontmatter
            FM=$(sed -n '2,/^---$/p' "$file" | head -n -1)
            
            # Parse fields
            get_field() { echo "$FM" | grep "^$1:" | sed "s/^$1: *//" | sed 's/^"//;s/"$//;s/^null$//' | tr -d '\r'; }
            
            ID=$(get_field id)
            TITLE=$(get_field title)
            STATUS=$(get_field status)
            CU_ID=$(get_field clickup_task_id)
            EPIC=$(get_field epic_id)
            
            echo "  Title: $TITLE | Status: $STATUS | CU_ID: $CU_ID"
            
            # Set type and list
            if [[ "$file" == *"/epics/"* ]]; then
              TYPE="epic"
              LIST="$EPICS_LIST"
              case "$STATUS" in to-do) CU_ST="to do";; in-progress) CU_ST="in progress";; done) CU_ST="complete";; *) CU_ST="to do";; esac
            else
              TYPE="story"
              LIST="$STORIES_LIST"
              case "$STATUS" in to-do) CU_ST="Open";; scoping) CU_ST="scoping";; in-design) CU_ST="in design";; *) CU_ST="Open";; esac
            fi
            
            
            # Get description using awk (content after 2nd ---)
            DESC=$(awk 'BEGIN{c=0} /^---$/{c++;next} c>=2{print}' "$file" | head -50)
            
            # Build full description with metadata
            if [ -n "$EPIC" ]; then
              FULL_DESC="**Epic**: ${EPIC}

---

${DESC}

---
_Source: ${file}_"
            else
              FULL_DESC="${DESC}

---
_Source: ${file}_"
            fi
            
            # Build JSON (jq handles multiline strings properly)
            NAME="[$TYPE] $TITLE"
            JSON=$(jq -n --arg n "$NAME" --arg d "$FULL_DESC" --arg s "$CU_ST" --arg t "$TYPE" \
              '{name:$n, description:$d, status:$s, tags:["bmad",$t]}')
            
            if [ -z "$CU_ID" ]; then
              echo "  Creating task..."
              RES=$(curl -sf -X POST "https://api.clickup.com/api/v2/list/$LIST/task" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$JSON" 2>&1) || { echo "  API Error: $RES"; continue; }
              
              NEW_ID=$(echo "$RES" | jq -r '.id // empty')
              if [ -n "$NEW_ID" ]; then
                echo "  Created: $NEW_ID"
                sed -i "s/^clickup_task_id:.*/clickup_task_id: \"$NEW_ID\"/" "$file"
              else
                echo "  Failed: $RES"
              fi
            else
              echo "  Updating $CU_ID..."
              UPJSON=$(jq -n --arg n "$NAME" --arg d "$DESC" --arg s "$CU_ST" '{name:$n,description:$d,status:$s}')
              curl -sf -X PUT "https://api.clickup.com/api/v2/task/$CU_ID" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$UPJSON" > /dev/null 2>&1 || echo "  Update failed"
              echo "  Updated"
            fi
          done
          echo "Sync complete"

      - name: Commit ClickUp IDs
        if: steps.changed.outputs.files != ''
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add _bmad-output/
          git diff --staged --quiet || { git commit -m "chore: Update ClickUp IDs [skip ci]" && git push; }
