name: Sync BMAD Artifacts to ClickUp

on:
  push:
    branches: [main]
    paths:
      - '_bmad-output/epics/**/*.md'
      - '_bmad-output/stories/**/*.md'

env:
  CLICKUP_EPICS_LIST_ID: "901815396322"
  CLICKUP_STORIES_LIST_ID: "901815396340"
  EMAIL_TO_CLICKUP_ID: "work.huutrung@gmail.com:300697285,mazhnguyen@kwayvina.com:300697285"

permissions:
  contents: write

jobs:
  sync-to-clickup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Changed Files and Author
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '_bmad-output/(epics|stories)/.*\.md$' | tr '\n' ' ' || echo "")
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "Found: $CHANGED | Author: $AUTHOR_EMAIL"

      - name: Sync to ClickUp
        if: steps.changed.outputs.files != ''
        env:
          CLICKUP_API_KEY: ${{ secrets.CLICKUP_API_KEY }}
          EPICS_LIST: ${{ env.CLICKUP_EPICS_LIST_ID }}
          STORIES_LIST: ${{ env.CLICKUP_STORIES_LIST_ID }}
          EMAIL_MAP: ${{ env.EMAIL_TO_CLICKUP_ID }}
          COMMIT_AUTHOR: ${{ steps.changed.outputs.author_email }}
        run: |
          echo "Starting sync..."
          
          # Helper functions
          get_user_id() { echo "$EMAIL_MAP" | tr ',' '\n' | grep "^$1:" | cut -d':' -f2 | head -1; }
          
          date_to_ms() {
            if [ -n "$1" ] && [ "$1" != "null" ]; then
              date -d "$1" +%s000 2>/dev/null || echo ""
            fi
          }
          
          hours_to_ms() {
            if [ -n "$1" ] && [ "$1" != "null" ]; then
              echo $(( $1 * 3600000 ))
            fi
          }
          
          priority_map() {
            case "$1" in urgent) echo 1;; high) echo 2;; normal) echo 3;; low) echo 4;; *) echo "";; esac
          }
          
          # Build epic mapping: epic_id:clickup_id,...
          EPIC_MAP=""
          if ls _bmad-output/epics/*.md 1>/dev/null 2>&1; then
            for f in _bmad-output/epics/*.md; do
              FM=$(sed -n '2,/^---$/p' "$f" 2>/dev/null | head -n -1)
              E_ID=$(echo "$FM" | grep "^id:" | sed 's/^id: *//' | sed 's/^"//;s/"$//' | tr -d '\r')
              E_CU=$(echo "$FM" | grep "^clickup_task_id:" | sed 's/^clickup_task_id: *//' | sed 's/^"//;s/"$//;s/^null$//' | tr -d '\r')
              if [ -n "$E_ID" ] && [ -n "$E_CU" ]; then
                EPIC_MAP="${EPIC_MAP}${E_ID}:${E_CU},"
              fi
            done
          fi
          echo "Epic map: $EPIC_MAP"
          
          get_epic_cu() { echo "$EPIC_MAP" | tr ',' '\n' | grep "^$1:" | cut -d':' -f2 | head -1; }
          
          for file in ${{ steps.changed.outputs.files }}; do
            echo "== Processing: $file =="
            
            FM=$(sed -n '2,/^---$/p' "$file" | head -n -1)
            get_field() { echo "$FM" | grep "^$1:" | sed "s/^$1: *//" | sed 's/^"//;s/"$//;s/^null$//' | tr -d '\r'; }
            
            ID=$(get_field id)
            TITLE=$(get_field title)
            STATUS=$(get_field status)
            CU_ID=$(get_field clickup_task_id)
            EPIC=$(get_field epic_id)
            ASSIGNED=$(get_field assigned_to)
            PRIORITY=$(get_field priority)
            START_DATE=$(get_field start_date)
            DUE_DATE=$(get_field due_date)
            TIME_EST=$(get_field time_estimate)
            TAGS_RAW=$(get_field tags)
            
            echo "  $ID: $TITLE | Status=$STATUS | Priority=$PRIORITY | Tags=$TAGS_RAW"
            
            # Build assignees
            ASSIGNEES="[]"
            if [ -n "$ASSIGNED" ]; then
              CLEAN=$(echo "$ASSIGNED" | tr -d '[]"' | tr ',' ' ')
              IDS=""
              for email in $CLEAN; do
                uid=$(get_user_id "$email")
                [ -n "$uid" ] && IDS="${IDS}${uid},"
              done
              if [ -n "$IDS" ]; then
                ASSIGNEES=$(echo "$IDS" | sed 's/,$//' | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0) | tonumber)')
              fi
            else
              uid=$(get_user_id "$COMMIT_AUTHOR")
              [ -n "$uid" ] && ASSIGNEES="[$uid]"
            fi
            
            # Type and status mapping
            if [[ "$file" == *"/epics/"* ]]; then
              TYPE="epic"; LIST="$EPICS_LIST"
              case "$STATUS" in to-do) CU_ST="to do";; in-progress) CU_ST="in progress";; done) CU_ST="complete";; cancelled) CU_ST="cancelled";; *) CU_ST="to do";; esac
            else
              TYPE="story"; LIST="$STORIES_LIST"
              case "$STATUS" in to-do) CU_ST="Open";; scoping) CU_ST="scoping";; in-design) CU_ST="in design";; ready-for-dev|in-progress) CU_ST="ready for dev";; cancelled) CU_ST="cancelled";; *) CU_ST="Open";; esac
            fi
            
            # Description
            DESC=$(awk 'BEGIN{c=0} /^---$/{c++;next} c>=2{print}' "$file" | head -50)
            if [ -n "$EPIC" ]; then
              FULL_DESC=$(printf "**Epic**: %s\n\n---\n\n%s\n\n---\n_Source: %s_" "$EPIC" "$DESC" "$file")
            else
              FULL_DESC=$(printf "%s\n\n---\n_Source: %s_" "$DESC" "$file")
            fi
            
            # Build tags array from frontmatter (use existing tags only, no auto-create)
            TAGS_JSON="[]"
            if [ -n "$TAGS_RAW" ]; then
              CLEAN_TAGS=$(echo "$TAGS_RAW" | tr -d '[]"' | tr ',' '\n' | xargs)
              if [ -n "$CLEAN_TAGS" ]; then
                TAGS_JSON=$(echo "$CLEAN_TAGS" | tr ' ' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0))')
              fi
            fi
            
            # Build payload
            NAME="[$TYPE] $TITLE"
            PAYLOAD=$(jq -n --arg n "$NAME" --arg d "$FULL_DESC" --arg s "$CU_ST" --argjson a "$ASSIGNEES" --argjson t "$TAGS_JSON" \
              '{name:$n, description:$d, status:$s, tags:$t, assignees:$a}')
            
            # Optional fields
            PRI=$(priority_map "$PRIORITY")
            [ -n "$PRI" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson p "$PRI" '. + {priority:$p}')
            
            START_MS=$(date_to_ms "$START_DATE")
            [ -n "$START_MS" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson s "$START_MS" '. + {start_date:$s}')
            
            DUE_MS=$(date_to_ms "$DUE_DATE")
            [ -n "$DUE_MS" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson d "$DUE_MS" '. + {due_date:$d}')
            
            TIME_MS=$(hours_to_ms "$TIME_EST")
            [ -n "$TIME_MS" ] && PAYLOAD=$(echo "$PAYLOAD" | jq --argjson t "$TIME_MS" '. + {time_estimate:$t}')
            
            # Link to epic
            if [ "$TYPE" = "story" ] && [ -n "$EPIC" ]; then
              EPIC_CU=$(get_epic_cu "$EPIC")
              if [ -n "$EPIC_CU" ]; then
                PAYLOAD=$(echo "$PAYLOAD" | jq --arg l "$EPIC_CU" '. + {links_to:$l}')
                echo "  Linking to $EPIC -> $EPIC_CU"
              fi
            fi
            
            if [ -z "$CU_ID" ]; then
              echo "  Creating..."
              RES=$(curl -sf -X POST "https://api.clickup.com/api/v2/list/$LIST/task" \
                -H "Authorization: $CLICKUP_API_KEY" -H "Content-Type: application/json" \
                -d "$PAYLOAD" 2>&1) || { echo "  Error: $RES"; continue; }
              
              NEW_ID=$(echo "$RES" | jq -r '.id // empty')
              if [ -n "$NEW_ID" ]; then
                echo "  Created: $NEW_ID"
                sed -i "s/^clickup_task_id:.*/clickup_task_id: \"$NEW_ID\"/" "$file"
              else
                echo "  Failed: $RES"
              fi
            else
              echo "  Updating $CU_ID..."
              UP=$(echo "$PAYLOAD" | jq 'del(.links_to)')
              curl -sf -X PUT "https://api.clickup.com/api/v2/task/$CU_ID" \
                -H "Authorization: $CLICKUP_API_KEY" -H "Content-Type: application/json" \
                -d "$UP" > /dev/null 2>&1 && echo "  Updated" || echo "  Update failed"
            fi
          done
          echo "Sync complete"

      - name: Commit ClickUp IDs
        if: steps.changed.outputs.files != ''
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add _bmad-output/
          git diff --staged --quiet || { git commit -m "chore: Update ClickUp IDs [skip ci]" && git push; }
